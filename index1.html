<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <script>
      function fetchInfo() {
        const phone = document.getElementById('phone').value;
        if (!phone) {
          alert("Please enter a phone number.");
          return;
        }

        google.script.run.withSuccessHandler(handleFetchResponse).fetchRecordByPhone(phone);
      }

      function handleFetchResponse(response) {
        if (response.status === 'found') {
          populateForm(response.data);
        } else {
          document.getElementById('lastNameSection').style.display = 'block';
        }
      }

      function searchByLastName() {
        const lastName = document.getElementById('lastName').value;
        if (!lastName) {
          alert("Please enter a last name.");
          return;
        }

        google.script.run.withSuccessHandler(displayMatches).searchRecordsByLastName(lastName);
      }

      function displayMatches(matches) {
        const list = document.getElementById('matchList');
        list.innerHTML = '';
        matches.forEach((record, index) => {
          const item = document.createElement('li');
          item.innerHTML = `<button onclick="selectRecord(${index})">${record.phone} - ${record.lastName}</button>`;
          list.appendChild(item);
        });
        document.getElementById('recordSelection').style.display = 'block';
      }

      function selectRecord(index) {
        google.script.run.withSuccessHandler(populateForm).getRecordByIndex(index);
      }

      function createNewRecord() {
        document.getElementById('form').reset();
        document.getElementById('recordSelection').style.display = 'none';
        document.getElementById('lastNameSection').style.display = 'none';
      }

      function populateForm(data) {
        for (const key in data) {
          if (document.getElementById(key)) {
            document.getElementById(key).value = data[key];
          }
        }
      }
    </script>
  </head>
  <body>
    <h2>GEC '81 - December 2025 Gathering @Bhopal</h2>
    <form id="form">
      <label>Phone Number:</label>
      <input type="text" id="phone">
      <button type="button" onclick="fetchInfo()">Fetch Existing Info</button><br><br>

      <div id="lastNameSection" style="display:none;">
        <label>Last Name:</label>
        <input type="text" id="lastName">
        <button type="button" onclick="searchByLastName()">Search</button>
      </div>

      <div id="recordSelection" style="display:none;">
        <ul id="matchList"></ul>
        <button type="button" onclick="createNewRecord()">Create NEW Record</button>
      </div>

      <br><label>First Name:</label><input type="text" id="firstName"><br>
      <label>Last Name:</label><input type="text" id="lastNameField"><br>
      <label>Date of Birth:</label><input type="date" id="dob"><br>
      <label>Email ID:</label><input type="email" id="email"><br>
      <label>Current Address:</label><input type="text" id="address"><br>
      <label>City:</label><input type="text" id="city"><br>
      <label>Branch:</label>
      <select id="branch">
        <option>Civil</option>
        <option>Mechanical</option>
        <option>Electrical</option>
        <option>Electronics & Telecommunication</option>
      </select><br>
      <label>Spouse's Name:</label><input type="text" id="spouse"><br>
      <label>Wedding Anniversary Date:</label><input type="date" id="anniversary"><br>
      <label>Accommodation Requirement:</label>
      <select id="accommodation">
        <option>Yes</option>
        <option>No</option>
      </select><br>
      <label>Arrival Date/Time to Jabalpur:</label><input type="datetime-local" id="arrival"><br>
      <label>Departure Date/Time:</label><input type="datetime-local" id="departure"><br>
      <label>Number of Members Attending:</label><input type="number" id="members"><br>
      <label>Attending Alone/With spouse:</label>
      <select id="attending">
        <option>Alone</option>
        <option>With spouse</option>
      </select><br><br>

      <button type="submit">Submit / Update</button>
    </form>
  </body>
</html>
